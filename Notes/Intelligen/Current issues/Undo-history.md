---
categories:
  - "[[Work]]"
  - "[[Issues]]"
created: 2025-06-24T10:17
tags:
  - intelligen
status: current
product: ScpCloud
---

**Ξ²Ββ€¦** **Ξβ€” ΞΒ²ΞΒ±ΞΖ’ΞΞ‰ΞΞΞΒ® Ξβ‚¬ΞΒΞΞΞΖ’ΞΒ­ΞΒ³ΞΒ³ΞΞ‰ΞΖ’ΞΒ· ΞΖ’ΞΞΞβ€¦ ΞΒµΞβ€•ΞΒ½ΞΒ±ΞΞ‰ ΞΖ’Ξβ€°ΞΖ’Ξβ€ΞΒ® Ξβ€¦Ξβ‚¬ΞΒ Ξβ‚¬ΞΒΞΞΞβ€ΉΞβ‚¬ΞΞΞΞΞΒ­ΞΖ’ΞΒµΞΞ‰Ξβ€**  
ΞΒ¤ΞΞ ΞΒ½ΞΒ± ΞΞΞΒΞΒ±Ξβ€ΞΒ¬Ξβ€ snapshots ΞΞΞΒ»ΞΒΞΞΞΒ»ΞΒ·ΞΒΞβ€°ΞΒ½ entities ΞΖ’Ξβ€ΞΞ history schema ΞΞΞΒ±ΞΞ‰ ΞΒ½ΞΒ± ΞΞΞβ‚¬ΞΞΞΒΞΒµΞβ€•Ξβ€ ΞΒ½ΞΒ± Ξβ€ΞΒ± ΞΒµΞβ‚¬ΞΒ±ΞΒ½ΞΒ±Ξβ€ ΞΒ­ΞΒΞΒµΞΞ‰Ξβ€ (restore/undo) ΞΒµΞβ€•ΞΒ½ΞΒ±ΞΞ‰ ΞΞΞΞ‰ΞΒ± ΞΞΞΞΞΞ‰ΞΒ½ΞΒ® Ξβ‚¬ΞΒΞΞΞΖ’ΞΒ­ΞΒ³ΞΒ³ΞΞ‰ΞΖ’ΞΒ· ΞΒ³ΞΞ‰ΞΒ± audit/versioning/undo.  
Ξβ€ΞΒ½ ΞΒ­Ξβ€΅ΞΒµΞΞ‰Ξβ€:

- dbo schema ΞΞΞΒµ ΞΞΞΒ±ΞΒ½ΞΞΞΒ½ΞΞ‰ΞΞΞΒ¬ ΞΞ„ΞΒµΞΞ„ΞΞΞΞΞΒ­ΞΒ½ΞΒ±
- history schema ΞΞΞΒµ "ΞΞ‰ΞΖ’Ξβ€ΞΞΞΒΞΞ‰ΞΞΞΒ¬ ΞΖ’Ξβ€ΞΞ‰ΞΒ³ΞΞΞΞ‰ΞΒΞβ€Ξβ€¦Ξβ‚¬ΞΒ±" Ξβ€Ξβ€°ΞΒ½ entities
- MemoryCache Ξβ‚¬ΞΞΞβ€¦ ΞΞΞΒΞΒ±Ξβ€ΞΒ¬ Ξβ€ΞΞ Ξβ€ΞΒΞΒ­Ξβ€΅ΞΞΞΒ½ entity
- ΞΒΞΒ±ΞΞ‰ ΞΞ ΞΖ’Ξβ€ΞΒΞβ€΅ΞΞΞβ€ ΞΒµΞβ€•ΞΒ½ΞΒ±ΞΞ‰ **replace** ΞΒµΞΒ½ΞΒΞβ€ entity ΞΒ±Ξβ‚¬ΞΒ snapshot

ΞΒ¤ΞΒΞβ€ΞΒµ Ξβ€ΞΞ ΞΒ²ΞΒ±ΞΖ’ΞΞ‰ΞΞΞΒ flow ΞΒ»ΞΒµΞΞ‰Ξβ€ΞΞΞβ€¦ΞΒΞΒ³ΞΒµΞβ€•, **ΞΒ±ΞΒ»ΞΒ»ΞΒ¬** Ξβ€¦Ξβ‚¬ΞΒ¬ΞΒΞβ€΅ΞΞΞβ€¦ΞΒ½ ΞΞΞΒ­ΞΞΞΒ±Ξβ€ΞΒ± Ξβ‚¬ΞΞΞβ€¦ ΞΞΞΒ­ΞΒ»ΞΞΞβ€¦ΞΒ½ Ξβ‚¬ΞΒΞΞΞΖ’ΞΞΞβ€΅ΞΒ®:
 
**Ξ²ΒΒ ΞΏΞΒ** **ΞΒ ΞΒΞΒΞΒ²ΞΒ»ΞΒ·ΞΞΞΒ± ΞΞΞΒµ Ξβ€ΞΒ± Id ΞΞΞΒ±ΞΞ‰ foreign keys**  
**1. ΞΒ¤ΞΒ± Id ΞΒµΞβ€•ΞΒ½ΞΒ±ΞΞ‰ auto-increment ΞΖ’Ξβ€ΞΞ dbo**  
Ξβ€ ΞΒΞΒ± ΞΒ±ΞΒ½ Ξβ‚¬ΞΒ±Ξβ€ ΞΒ½ΞΒ± "ΞΒµΞβ‚¬ΞΒ±ΞΒ½ΞΒ±Ξβ€ ΞΒ­ΞΒΞΒµΞΞ‰Ξβ€" ΞΒ­ΞΒ½ΞΒ± entity ΞΒ±Ξβ‚¬ΞΒ history, ΞΞ„ΞΒµΞΒ½ ΞΞΞβ‚¬ΞΞΞΒΞΒµΞβ€•Ξβ€ ΞΒ½ΞΒ± ΞΞΞΒ±ΞΒ½ΞΒ±Ξβ€΅ΞΒΞΒ·ΞΖ’ΞΞ‰ΞΞΞΞΞβ‚¬ΞΞΞΞ‰ΞΒ®ΞΖ’ΞΒµΞΞ‰Ξβ€ Ξβ€ΞΞ Ξβ€•ΞΞ„ΞΞ‰ΞΞ Id **ΞΒ±ΞΒ½ Ξβ€¦Ξβ‚¬ΞΒ¬ΞΒΞβ€΅ΞΒµΞΞ‰ ΞΒ®ΞΞ„ΞΒ·**.  
**2. ΞΒ¤ΞΒ± FK entities ΞΞΞβ‚¬ΞΞΞΒΞΒµΞβ€• ΞΒ½ΞΒ± ΞΒ­Ξβ€΅ΞΞΞβ€¦ΞΒ½ ΞΞ„ΞΞ‰ΞΒ±ΞΒ³ΞΒΞΒ±Ξβ€ ΞΒµΞβ€•**  
Ξβ€ΞΒ½ Ξβ‚¬.Ξβ€΅. ΞΒ­ΞΒ½ΞΒ± entity A ΞΒ­Ξβ€΅ΞΒµΞΞ‰ FK -\> B, ΞΞΞΒ±ΞΞ‰ Ξβ€ΞΞ B ΞΒ­Ξβ€΅ΞΒµΞΞ‰ ΞΞ„ΞΞ‰ΞΒ±ΞΒ³ΞΒΞΒ±Ξβ€ ΞΒµΞβ€• ΞΒ±Ξβ‚¬ΞΒ Ξβ€ΞΞ dbo, Ξβ€ΞΒΞβ€ΞΒµ ΞΞΞΒ±Ξβ€ΞΒ¬ Ξβ€ΞΒ·ΞΒ½ ΞΒ±Ξβ‚¬ΞΞΞΞΞΒ±Ξβ€ΞΒ¬ΞΖ’Ξβ€ΞΒ±ΞΖ’ΞΒ· ΞΞ„ΞΒµΞΒ½ ΞΞΞΒ± ΞΞΞβ‚¬ΞΞΞΒΞΒµΞβ€•Ξβ€ ΞΒ½ΞΒ± ΞΞΞΒ¬ΞΒ½ΞΒµΞΞ‰Ξβ€ attach/reference.
 
**Ο€Ββ€β€** **ΞΒ ΞΞ‰ΞΞΞΒ±ΞΒ½ΞΒ­Ξβ€ ΞΒ£Ξβ€ΞΒΞΒ±Ξβ€ΞΒ·ΞΒ³ΞΞ‰ΞΞΞΒ­Ξβ€**  
**Ξ²Ββ€¦** **1. ΞΒ¤ΞΒ± ΞΞ‰ΞΖ’Ξβ€ΞΞΞΒΞΞ‰ΞΞΞΒ¬ entities ΞΞΞΒΞΒ±Ξβ€ΞΞΞΒΞΒ½ Ξβ€ΞΞ Id, ΞΒ±ΞΒ»ΞΒ»ΞΒ¬ ΞΒ±Ξβ€¦Ξβ€ΞΒ ΞΞ„ΞΒµΞΒ½ Ξβ€΅ΞΒΞΒ·ΞΖ’ΞΞ‰ΞΞΞΞΞβ‚¬ΞΞΞΞ‰ΞΒµΞβ€•Ξβ€ΞΒ±ΞΞ‰ ΞΒ³ΞΞ‰ΞΒ± insert**  
**ΞΒ£Ξβ€ΞΞΞΒ½ history schema:**

- ΞΒΞΒΞΒ±Ξβ€ΞΒ¬Ξβ€ Ξβ€ΞΒ± Id, FK Ids, ΞΞΞΒ±ΞΞ‰ ΞΒΞΒ»ΞΒ± Ξβ€ΞΒ± navigation properties _ΞΒΞβ‚¬Ξβ€°Ξβ€ ΞΒ®Ξβ€ΞΒ±ΞΒ½_.
- ΞΒΞβ‚¬ΞΒΞβ€ΞΒµ ΞΒµΞβ€•ΞΒ½ΞΒ±ΞΞ‰ **read-only snapshots**.

**ΞΒΞΒ±Ξβ€ΞΒ¬ Ξβ€ΞΞ Undo:**

- ΞΒ ΞΒ±Ξβ€•ΞΒΞΒ½ΞΒµΞΞ‰Ξβ€ Ξβ€ΞΞ entity ΞΒ±Ξβ‚¬ΞΒ history
- **Ξβ€Ξβ€ΆΞΒ** ΞΒµΞβ‚¬ΞΒ±ΞΒ½ΞΒ±Ξβ€ ΞΒ­ΞΒΞΒµΞΞ‰Ξβ€ Ξβ€ΞΞ Id
- ΞΒΞΒ¬ΞΒ½ΞΒµΞΞ‰Ξβ€:
original.Id = 0;
context.Entry(original).State = EntityState.Added;

ΞΒ®

var restored = mapper.Map\<OriginalEntity\>(historyEntity);
restored.Id = 0;
dboContext.Add(restored);

Ξβ€ΞΒ½ Ξβ€΅ΞΒΞΒ·ΞΖ’ΞΞ‰ΞΞΞΞΞβ‚¬ΞΞΞΞ‰ΞΒµΞβ€•Ξβ€ AutoMapper, Ξβ€΅ΞΒΞΒ·ΞΖ’ΞΞ‰ΞΞΞΞΞβ‚¬ΞΞΞβ€•ΞΒ·ΞΖ’ΞΒµ projection Ξβ€΅Ξβ€°ΞΒΞβ€•Ξβ€ ΞΒ½ΞΒ± ΞΞΞΒµΞβ€ΞΒ±Ξβ€ ΞΒ­ΞΒΞΒµΞΞ‰Ξβ€ Ξβ€ΞΞ Id.
 
**Ξ²Ββ€¦** **2. ΞΒ ΞΒΞΞ‰ΞΒ½ Ξβ€ΞΞ undo, ΞΒµΞΒ»ΞΒ­ΞΒ³Ξβ€΅ΞΒµΞΞ‰Ξβ€ ΞΒ±ΞΒ½ Ξβ€ΞΒ± related entities Ξβ€¦Ξβ‚¬ΞΒ¬ΞΒΞβ€΅ΞΞΞβ€¦ΞΒ½**

- Ξβ€ΞΒ½ ΞΞΞΒ¬Ξβ‚¬ΞΞΞΞ‰ΞΞ related entity (Ξβ‚¬.Ξβ€΅. CategoryId) ΞΒ­Ξβ€΅ΞΒµΞΞ‰ ΞΖ’ΞΒ²ΞΒ·ΞΖ’Ξβ€ΞΒµΞβ€•, ΞΒµΞβ€•Ξβ€ΞΒµ:
    - ΞΒ¤ΞΞ ΞΞΞΒ±ΞΒ½ΞΒ±ΞΞ„ΞΒ·ΞΞΞΞ‰ΞΞΞβ€¦ΞΒΞΒ³ΞΒµΞβ€•Ξβ€ ΞΒ±Ξβ‚¬ΞΒ Ξβ€ΞΞ history (ΞΒ±ΞΒ½ ΞΒ­Ξβ€΅ΞΒµΞΞ‰Ξβ€ snapshot Ξβ€ΞΞΞβ€¦)
    - Ξβ€° ΞΞΞΒ±ΞΞΞΒ±ΞΒΞβ€•ΞΒ¶ΞΒµΞΞ‰Ξβ€ Ξβ€ΞΞ FK field ΞΞΞΒ±ΞΞ‰ ΞΒ±Ξβ€ ΞΒ®ΞΒ½ΞΒµΞΞ‰Ξβ€ null (ΞΒ±ΞΒ½ ΞΒµΞβ‚¬ΞΞ‰Ξβ€ΞΒΞΒ­Ξβ‚¬ΞΒµΞβ€ΞΒ±ΞΞ‰)
 
**Ξ²Ββ€¦** **3. Ξβ€ΆΞΒ½ΞΒ±ΞΒ»ΞΒ»ΞΒ±ΞΞΞβ€ΞΞ‰ΞΞΞΒ¬: Ξβ€΅ΞΒΞΒ·ΞΖ’ΞΞ‰ΞΞΞΞΞβ‚¬ΞΞΞΞ‰ΞΒµΞβ€•Ξβ€ soft deletes**  
Ξβ€ΞΒ½ ΞΒ­Ξβ€΅ΞΒµΞΞ‰Ξβ€ soft delete (Ξβ‚¬.Ξβ€΅. IsDeleted flag) ΞΒ±ΞΒ½Ξβ€Ξβ€• ΞΒ³ΞΞ‰ΞΒ± hard delete, Ξβ€ΞΒΞβ€ΞΒµ Ξβ€ΞΒ± related entities Ξβ‚¬ΞΒ±ΞΒΞΒ±ΞΞΞΒ­ΞΒ½ΞΞΞβ€¦ΞΒ½ ΞΖ’Ξβ€ΞΞ dbo, ΞΒ¬ΞΒΞΒ± ΞΞΞβ‚¬ΞΞΞΒΞΒµΞβ€•Ξβ€ ΞΒ½ΞΒ± Ξβ€ΞΒ± ΞΞΞΒ¬ΞΒ½ΞΒµΞΞ‰Ξβ€ restore Ξβ€΅Ξβ€°ΞΒΞβ€•Ξβ€ conflict.
 
**Ο€ΒΒβ€”ΞΏΞΒ** **ΞΒ ΞΒ±ΞΒΞΒ¬ΞΞ„ΞΒµΞΞ‰ΞΒ³ΞΞΞΒ±: Restore Entity ΞΒ±Ξβ‚¬ΞΒ history**
 ```csharp
var historyEntity = historyContext.Entities.Find(historyId);
  
// Detach from history context
historyContext.Entry(historyEntity).State = EntityState.Detached;
  
// Create new copy
var restored = new OriginalEntity
{
 // manually copy fields, excluding ID
 Name = historyEntity.Name,
 CategoryId = historyEntity.CategoryId,
 // ...
};
  
dboContext.Entities.Add(restored);
await dboContext.SaveChangesAsync();
 ```

 
**ΞΒ ΞΒΞΞΞΖ’ΞΞΞβ€΅ΞΒ® ΞΖ’Ξβ€ΞΒ± ΞΒµΞΞΞΒ®Ξβ€**

1. **Validation Ξβ€Ξβ€°ΞΒ½ FK Ξβ‚¬ΞΒΞΞ‰ΞΒ½ restore**
	Ξβ€ΞΒ½ restored.CategoryId ΞΞ„ΞΒµΞβ€•Ξβ€΅ΞΒ½ΞΒµΞΞ‰ ΞΖ’ΞΒµ ΞΞΞΒ±Ξβ€ΞΒ·ΞΒ³ΞΞΞΒΞβ€•ΞΒ± Ξβ‚¬ΞΞΞβ€¦ ΞΒ­Ξβ€΅ΞΒµΞΞ‰ ΞΞ„ΞΞ‰ΞΒ±ΞΒ³ΞΒΞΒ±Ξβ€ ΞΒµΞβ€•, Ξβ‚¬ΞΒΞΒ­Ξβ‚¬ΞΒµΞΞ‰ ΞΒ½ΞΒ± Ξβ€΅ΞΒµΞΞ‰ΞΒΞΞ‰ΞΖ’Ξβ€ΞΒµΞβ€•Ξβ€ Ξβ€ΞΒ·ΞΒ½ ΞΒ±Ξβ‚¬ΞΒΞΒ»ΞΒµΞΞ‰ΞΒ± (error ΞΒ® nullify ΞΒ® re-create).
2. **Consistency**
	Ξβ€ΞΒ½ ΞΞΞΒ¬ΞΒ½ΞΒµΞΞ‰Ξβ€ undo ΞΒµΞΒ½ΞΒΞβ€ parent entity, ΞΒ±ΞΒ»ΞΒ»ΞΒ¬ child entities ΞΒ»ΞΒµΞβ€•Ξβ‚¬ΞΞΞβ€¦ΞΒ½, Ξβ€΅ΞΒΞΒµΞΞ‰ΞΒ¬ΞΒ¶ΞΒµΞΖ’ΞΒ±ΞΞ‰ full recursive restore.
3. **Versioning**
	Ξβ€ΞΒ½ ΞΞΞΒ­ΞΒ»ΞΒµΞΞ‰Ξβ€ Ξβ‚¬ΞΞΞΒ»ΞΒ»ΞΒ±Ξβ‚¬ΞΒ»ΞΒ¬ undo ΞΒ²ΞΒ®ΞΞΞΒ±Ξβ€ΞΒ±, Ξβ‚¬ΞΒΞΒΞΖ’ΞΞΞΒµΞΖ’ΞΒµ VersionNumber ΞΒ® CreatedAt ΞΖ’Ξβ€ΞΞ history schema.
4. **Snapshots ΞΒΞβ€΅ΞΞ‰ ΞΞΞΒΞΒ½ΞΞ entity ΞΒ±ΞΒ»ΞΒ»ΞΒ¬ ΞΞΞΒ±ΞΞ‰ relations**
	Ξβ€ΞΒ½ ΞΞΞΒ¬ΞΒ½ΞΒµΞΞ‰Ξβ€ restore Order, ΞΞΞβ‚¬ΞΞΞΒΞΒµΞβ€• ΞΒ½ΞΒ± Ξβ‚¬ΞΒΞΒ­Ξβ‚¬ΞΒµΞΞ‰ ΞΒ½ΞΒ± ΞΞΞΒ¬ΞΒ½ΞΒµΞΞ‰Ξβ€ restore ΞΞΞΒ±ΞΞ‰ OrderItems.
 
**Ξ²Ββ€¦** **ΞΒ£Ξβ€¦ΞΞΞβ‚¬ΞΒµΞΒΞΒ±ΞΖ’ΞΞΞΒ±Ξβ€ΞΞ‰ΞΞΞΒ¬**

- **Ξβ€” Ξβ‚¬ΞΒΞΞΞΖ’ΞΒ­ΞΒ³ΞΒ³ΞΞ‰ΞΖ’ΞΒ· ΞΞΞΒµ second context ΞΞΞΒ±ΞΞ‰ schema ΞΒµΞβ€•ΞΒ½ΞΒ±ΞΞ‰ ΞΖ’Ξβ€°ΞΖ’Ξβ€ΞΒ®**
- **ΞΒΞΒ·ΞΒ½ ΞΞΞΒ±ΞΒ½ΞΒ±Ξβ€΅ΞΒΞΒ·ΞΖ’ΞΞ‰ΞΞΞΞΞβ‚¬ΞΞΞΞ‰ΞΒµΞβ€•Ξβ€ Id**
- **ΞΒ£Ξβ€ΞΞ history ΞΞΞΒΞΒ¬Ξβ€ΞΒ± Ξβ€ΞΒ± Id, ΞΒ±ΞΒ»ΞΒ»ΞΒ¬ ΞΞΞΒ· Ξβ€ΞΒ± ΞΞΞΒ±ΞΒ½ΞΒ±ΞΞΞΒ¬ΞΒ½ΞΒµΞΞ‰Ξβ€ insert**
- **ΞΒ ΞΒΞΞ‰ΞΒ½ restore, ΞΒ­ΞΒ»ΞΒµΞΒ³ΞΞΞΒµ ΞΒ±ΞΒ½ Ξβ€ΞΒ± related data Ξβ€¦Ξβ‚¬ΞΒ¬ΞΒΞβ€΅ΞΞΞβ€¦ΞΒ½**
- **ΞΒΞΒ±ΞΞΞΒ¬ΞΒΞΞ‰ΞΖ’ΞΒµ ΞΒ® ΞΒµΞβ‚¬ΞΒ±ΞΒ½ΞΒ±ΞΞ„ΞΒ·ΞΞΞΞ‰ΞΞΞΒΞΒΞΒ³ΞΒ·ΞΖ’ΞΒµ Ξβ€ΞΒ± ΞΒ±Ξβ‚¬ΞΒ±ΞΒΞΒ±Ξβ€•Ξβ€ΞΒ·Ξβ€ΞΒ± relations**
- **ΞΒ§ΞΒΞΒ·ΞΖ’ΞΞ‰ΞΞΞΞΞβ‚¬ΞΞΞβ€•ΞΒ·ΞΖ’ΞΒµ mapping (Ξβ‚¬.Ξβ€΅. AutoMapper) ΞΒ® manual copy ΞΒ³ΞΞ‰ΞΒ± ΞΒ½ΞΒ± Ξβ€΅Ξβ€Ξβ€•ΞΖ’ΞΒµΞΞ‰Ξβ€ ΞΒ½ΞΒ­ΞΞ entity Ξβ€΅Ξβ€°ΞΒΞβ€•Ξβ€ Id**



